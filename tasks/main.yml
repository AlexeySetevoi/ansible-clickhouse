---
# tasks file for clickhouse
- include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution | lower }}_{{ ansible_distribution_release | lower }}.yml"
    - "empty.yml"
  tags: [always]

- include: precheck.yml
  tags: [always]

- include: install_apt.yml
  when: ansible_pkg_mgr == 'apt' and clickhouse_setup == 'package' and (clickhouse_rt_is_installed.rc !=0 or not clickhouse_is_required_version) and clickhouse_remove|bool == False
  tags: [install]

- include: install_yum.yml
  when: ansible_pkg_mgr == 'yum' and clickhouse_setup == 'package' and (clickhouse_rt_is_installed.rc !=0 or not clickhouse_is_required_version) and clickhouse_remove|bool == False
  tags: [install]

- include: precheck.yml
  tags: [always]

- include: config_sys.yml
  when: clickhouse_rt_is_installed.rc == 0 and clickhouse_remove|bool == False
  tags: [config,config_sys]

- name: Wait DBMS ready
  command: sleep 1

- include: config_db.yml
  when: clickhouse_rt_is_installed.rc == 0 and clickhouse_remove|bool == False
  tags: [config,config_db]

- include: config_dict.yml
  when: clickhouse_rt_is_installed.rc == 0 and clickhouse_remove|bool == False
  tags: [config,config_dict]

- include: remove_apt.yml
  when: ansible_pkg_mgr == 'apt' and clickhouse_setup == 'package' and clickhouse_rt_is_installed.rc == 0 and clickhouse_remove|bool == True
  tags: [remove]

- include: remove_yum.yml
  when: ansible_pkg_mgr == 'yum' and clickhouse_setup == 'package' and clickhouse_rt_is_installed.rc == 0 and clickhouse_remove|bool == True
  tags: [remove]